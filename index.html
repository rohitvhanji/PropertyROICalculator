<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prop Gain</title>
  <!-- PDF Generation Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      margin: 0; 
      padding: 15px;
      background-color: #f8f9fa; 
      color: #333;
    }
    .container { 
      max-width: 700px;
      margin: auto; 
      background: #fff; 
      padding: 25px; 
      border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
    }
    h1, h2 { 
      text-align: center; 
      color: #0056b3;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    .section { 
      margin-top: 35px;
    }
    .row { 
      display: flex; 
      gap: 20px; 
      flex-wrap: wrap;
    }
    .col { 
      flex: 1; 
      min-width: 250px;
    }
    /* New Grid Layout for Forms */
    .form-grid {
        display: grid;
        grid-template-columns: max-content 1fr;
        gap: 15px 20px; /* Row and column gap */
        align-items: center;
    }
    .form-grid label {
        margin-top: 0; /* Reset margin for grid items */
        text-align: right;
    }
    .calculated-value {
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 6px;
        font-weight: bold;
        text-align: center;
        height: 40px;
        box-sizing: border-box;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    label { 
      display: block; 
      margin-top: 15px; 
      font-weight: 600;
      color: #555;
    }
    input { 
      padding: 10px; 
      width: 100%; 
      margin-top: 5px; 
      border: 1px solid #ced4da;
      border-radius: 6px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    input:focus {
      border-color: #007bff;
      outline: none;
    }
    button { 
      margin-top: 20px; 
      padding: 12px 25px; 
      background: #007bff; 
      color: #fff; 
      border: none; 
      border-radius: 6px; 
      cursor: pointer; 
      font-size: 16px;
      transition: background-color 0.2s;
      width: 100%;
    }
    button:hover { 
      background: #0056b3; 
    }
    .add-btn {
        background-color: #28a745;
    }
    .add-btn:hover {
        background-color: #218838;
    }
    .export-btn {
        background-color: #17a2b8;
    }
    .export-btn:hover {
        background-color: #138496;
    }
    .remove-btn {
        background-color: #dc3545;
        padding: 5px 10px;
        font-size: 12px;
        width: auto;
        margin-left: 10px;
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 20px; 
      font-size: 14px;
    }
    th, td { 
      border: 1px solid #ddd; 
      padding: 10px; 
      text-align: center; 
    }
    th { 
      background: #f0f2f5; 
      font-weight: 600;
    }
    .summary-box {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    .summary-box p { margin: 8px 0; }
    .formula {
        font-family: monospace;
        font-size: 12px;
        color: #6c757d;
        text-align: center;
        margin-top: 5px;
    }
    .highlight {
        font-size: 1.1em;
        font-weight: bold;
        color: #0056b3;
    }
    .positive { color: #28a745; font-weight: bold; }
    .negative { color: #dc3545; font-weight: bold; }
    .rent-period {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
    }
    .rent-period > div {
        flex: 1;
    }
    /* Styles for PDF Export */
    .exporting button {
        display: none !important;
    }
    .print-text {
        display: inline-block;
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        box-sizing: border-box;
        background-color: #f8f9fa;
        min-height: 40px;
        text-align: left;
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .container {
        padding: 15px;
      }
      .form-grid {
        grid-template-columns: 1fr;
        gap: 10px 0;
      }
      .form-grid label {
        text-align: left;
        margin-bottom: 0;
      }
      input {
        min-height: 44px; /* Ensure consistent, tappable height */
      }
      .rent-period {
        flex-direction: column;
        align-items: stretch;
      }
      h1 {
        font-size: 1.5em;
      }
      h2 {
        font-size: 1.2em;
      }
      .summary-box b, .summary-box span {
        font-size: 0.95em;
      }
    }
  </style>
</head>
<body>
<div class="container" id="capture">
  <h1>Prop Gain ðŸ“ˆ</h1>

  <!-- Section 1: Purchase Costs -->
  <div class="section">
    <h2>1. Purchase Costs</h2>
    <div class="form-grid">
        <label for="agreementValue">Agreement Value</label>
        <input type="number" id="agreementValue" value="" min="0" placeholder="e.g., 5000000">
        
        <label for="stampDutyPercent">Stamp Duty (%)</label>
        <input type="number" id="stampDutyPercent" value="7" min="0" step="0.1">

        <label>Calculated Stamp Duty</label>
        <div class="calculated-value" id="stampDutyValue"></div>

        <label for="gstPercent">GST & Other Charges (%)</label>
        <input type="number" id="gstPercent" value="5" min="0" step="0.1">
        
        <label>Calculated GST</label>
        <div class="calculated-value" id="gstValue"></div>

        <label for="registrationCharges">Registration Charges (Fixed)</label>
        <input type="number" id="registrationCharges" value="30000" min="0">
    </div>
    <div class="summary-box" style="margin-top: 15px;">
        <p><b>All-Inclusive Price: <span id="allInclusivePrice" class="highlight"></span></b></p>
    </div>
  </div>

  <!-- Section 2: Loan Details -->
  <div class="section">
    <h2>2. Loan Details</h2>
    <div class="form-grid">
        <label for="ltvPercent">Max Loan Amount (LTV %)</label>
        <input type="number" id="ltvPercent" value="80" min="0" max="100">

        <label for="loanAmount">Loan Amount</label>
        <input type="number" id="loanAmount" value="" min="0" placeholder="Calculated from LTV">

        <label for="interestRate">Interest Rate (% p.a.)</label>
        <input type="number" id="interestRate" value="8.5" min="0" step="0.01">

        <label for="tenure">Tenure (months)</label>
        <input type="number" id="tenure" value="240" min="0">
        
        <label for="loanClosureDate">Loan Closure Date (optional)</label>
        <input type="month" id="loanClosureDate">
    </div>
    <div class="summary-box" style="margin-top: 15px;">
         <p><b>Required Downpayment: <span id="downpaymentValue" class="highlight"></span></b></p>
    </div>
    <div class="summary-box" style="margin-top: 15px;">
         <p><b>Monthly EMI: <span id="monthlyEMIValue" class="highlight"></span></b></p>
    </div>
  </div>

  <!-- Section 3: Investment Timeline -->
  <div class="section">
    <h2>3. Investment Timeline</h2>
    <div class="form-grid">
      <label for="bookingDate">Booking Date</label>
      <input type="month" id="bookingDate" value="">

      <label for="possessionDate">Possession Date</label>
      <input type="month" id="possessionDate" value="">
    </div>
  </div>
  
  <!-- Section 4: Income & Expenses -->
  <div class="section">
    <h2>4. Income & Expenses</h2>
    <label>Rental Income Periods</label>
    <div id="rentPeriodsContainer">
        <!-- Dynamic rent periods will be added here -->
    </div>
    <button onclick="addRentPeriod()" class="add-btn" style="margin-top:10px; width:auto; font-size: 14px; padding: 8px 15px;">+ Add Rent Period</button>
    
    <div class="form-grid" style="margin-top: 20px;">
      <label for="quarterlyMaintenance">Quarterly Maintenance</label>
      <input type="number" id="quarterlyMaintenance" value="" min="0" placeholder="e.g., 12000">
    </div>
  </div>

  <!-- Section 5: Sale Value -->
  <div class="section">
    <h2>5. Sale Value</h2>
    <div class="form-grid">
      <label for="salePrice">Expected Sale Price (optional)</label>
      <input type="number" id="salePrice" placeholder="Overrides appreciation % below" min="0">

      <label for="appRate">Annual Appreciation Rate (%)</label>
      <input type="number" id="appRate" value="5" min="0">
    </div>
  </div>

  <hr style="margin-top: 40px;">
  
  <!-- Section: Cash Flow -->
  <div class="section">
    <h2>Cash Flow (As of Today)</h2>
    <div class="row">
        <div class="col summary-box">
            <h3>Inflow ðŸ’°</h3>
            <p>Est. Current Property Value: <b id="currentPrice"></b></p>
            <p>Total Rent Collected: <b id="rentCollected"></b></p>
            <hr style="border-top: 1px solid #ddd; margin: 10px 0;">
            <p><b>Total Income: <span id="totalIncomeValue"></span></b></p>
        </div>
        <div class="col summary-box">
            <h3>Outflow ðŸ’¸</h3>
            <p>All-Inclusive Purchase Price: <b id="purchasePriceOutflow"></b></p>
            <p>Pre-Possession Interest: <b id="preEmiInterestPaid"></b></p>
            <p>Post-Possession Interest: <b id="amortizedInterestPaid"></b></p>
            <p><b>Total Interest Paid:</b> <b id="interestPaid"></b></p>
            <p>Total Maintenance Paid: <b id="maintenancePaid"></b></p>
            <hr style="border-top: 1px solid #ddd; margin: 10px 0;">
            <p><b>Total Expenses: <span id="totalExpensesValue"></span></b></p>
        </div>
    </div>
    <div class="summary-box" style="margin-top:20px; text-align:center;">
        <p><b>Net Profit / Loss (If Sold Today): <span id="netResult"></span></b></p>
        <p class="formula">(Total Income - Total Expenses)</p>
        <p><b>Absolute ROI (Profit / Your Capital): <span id="absoluteROI"></span></b></p>
        <p><b>Annualized ROI (CAGR): <span id="annualizedROI"></span></b></p>
    </div>
  </div>

  <hr style="margin-top: 40px;">

  <!-- Section: Projection -->
  <div class="section">
    <h2>Future Projection ðŸ”®</h2>
    <div class="form-grid">
      <label for="horizon">Projection Horizon (years)</label>
      <input type="number" id="horizon" value="5" min="1">

      <label for="rentIncrease">Annual Rent Increase (%)</label>
      <input type="number" id="rentIncrease" value="5" min="0">
    </div>
    <button onclick="generateProjection()">Generate Projection</button>
    <div id="projectionResult" style="overflow-x:auto;"></div>
  </div>

  <!-- Section: Export -->
  <div class="section">
      <button onclick="exportToPDF()" class="export-btn" id="exportBtn">Export to PDF</button>
  </div>

</div>

<script>
let isUpdating = false; // Flag to prevent infinite loops

// --- UTILITY FUNCTION ---
function fmt(num) {
  if (isNaN(num)) return "â‚¹0";
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    maximumFractionDigits: 0
  }).format(num);
}

// New function to format large numbers for mobile
function fmtShort(num) {
    if (isNaN(num)) return "â‚¹0";
    const absNum = Math.abs(num);
    const sign = num < 0 ? "-" : "";

    if (absNum < 100000) { // Below 1 Lakh
        return fmt(num); // Use the original full format
    } else if (absNum < 10000000) { // 1 Lakh to 1 Crore
        return `${sign}â‚¹${(absNum / 100000).toFixed(2)} L`;
    } else { // 1 Crore and above
        return `${sign}â‚¹${(absNum / 10000000).toFixed(2)} Cr`;
    }
}

function getMonthsDifference(d1, d2) {
    if (!d1 || !d2 || d1 > d2 || isNaN(d1.getTime()) || isNaN(d2.getTime())) return 0;
    
    let months;
    months = (d2.getFullYear() - d1.getFullYear()) * 12;
    months -= d1.getMonth();
    months += d2.getMonth();
    
    return months < 0 ? 0 : months + 1;
}


// --- DYNAMIC RENT PERIODS ---
function addRentPeriod(start = '', end = '', rent = '') {
    const container = document.getElementById('rentPeriodsContainer');
    const periodDiv = document.createElement('div');
    periodDiv.className = 'rent-period';

    periodDiv.innerHTML = `
        <div>
            <label style="font-size:12px; font-weight:normal;">Start Month</label>
            <input type="month" class="rent-start" value="${start}">
        </div>
        <div>
            <label style="font-size:12px; font-weight:normal;">End Month (leave blank if current)</label>
            <input type="month" class="rent-end" value="${end}">
        </div>
        <div>
            <label style="font-size:12px; font-weight:normal;">Monthly Rent</label>
            <input type="number" class="rent-amount" placeholder="e.g., 18000" value="${rent}">
        </div>
        <button class="remove-btn" onclick="this.parentElement.remove(); calculateROI();">X</button>
    `;
    container.appendChild(periodDiv);

    // Add event listeners to new inputs
    periodDiv.querySelectorAll('input').forEach(input => {
        const eventType = input.type === 'month' ? 'change' : 'input';
        input.addEventListener(eventType, calculateROI);
    });
}

function calculateTotalRentCollected() {
    const periods = document.querySelectorAll('.rent-period');
    const possessionDate = new Date(document.getElementById("possessionDate").value + "-02"); // Use 2nd to avoid timezone issues
    const today = new Date();
    let totalRent = 0;

    if (isNaN(possessionDate.getTime())) return 0;

    periods.forEach(period => {
        const startDateInput = period.querySelector('.rent-start').value;
        const endDateInput = period.querySelector('.rent-end').value;
        const rentAmount = parseFloat(period.querySelector('.rent-amount').value) || 0;

        if (!startDateInput) return;

        let periodStart = new Date(startDateInput + "-02");
        let periodEnd = endDateInput ? new Date(endDateInput + "-02") : today;
        
        if (isNaN(periodStart.getTime())) return;

        // Clamp the calculation window between possession date and today
        const effectiveStart = new Date(Math.max(possessionDate, periodStart));
        const effectiveEnd = new Date(Math.min(today, periodEnd));
        
        const months = getMonthsDifference(effectiveStart, effectiveEnd);
        totalRent += months * rentAmount;
    });
    return totalRent;
}

// --- CORE CALCULATION LOGIC ---
function calculateROI() {
  if (isUpdating) return;

  // 1. GET ALL INPUTS
  const agreement = parseFloat(document.getElementById("agreementValue").value) || 0;
  const stampPercent = parseFloat(document.getElementById("stampDutyPercent").value) || 0;
  const gstPercent = parseFloat(document.getElementById("gstPercent").value) || 0;
  const stampValue = agreement * (stampPercent / 100);
  const gstValue = agreement * (gstPercent / 100);
  
  document.getElementById('stampDutyValue').innerText = fmt(stampValue);
  document.getElementById('gstValue').innerText = fmt(gstValue);

  const loanClosureDateStr = document.getElementById("loanClosureDate").value;

  const inputs = {
    agreement: agreement,
    stamp: stampValue,
    reg: parseFloat(document.getElementById("registrationCharges").value) || 0,
    gst: gstValue,
    loanAmt: parseFloat(document.getElementById("loanAmount").value) || 0,
    ratePA: parseFloat(document.getElementById("interestRate").value) || 0,
    tenure: parseInt(document.getElementById("tenure").value) || 0,
    bookingDate: new Date(document.getElementById("bookingDate").value + "-02"),
    possessionDate: new Date(document.getElementById("possessionDate").value + "-02"),
    loanClosureDate: loanClosureDateStr ? new Date(loanClosureDateStr + "-02") : null,
    qMaint: parseFloat(document.getElementById("quarterlyMaintenance").value) || 0,
    salePrice: parseFloat(document.getElementById("salePrice").value) || 0,
    appRate: parseFloat(document.getElementById("appRate").value) / 100 || 0,
  };

  // 2. INITIAL CALCULATIONS
  const allIncPrice = inputs.agreement + inputs.stamp + inputs.reg + inputs.gst;
  document.getElementById("allInclusivePrice").innerText = fmt(allIncPrice);

  const downpayment = allIncPrice - inputs.loanAmt;
  document.getElementById("downpaymentValue").innerText = fmt(downpayment);
  
  const totalInitialCapital = downpayment;
  const monthlyRate = inputs.ratePA / 100 / 12;
  const today = new Date();
  
  const emi = inputs.loanAmt > 0 && monthlyRate > 0 && inputs.tenure > 0 ? (inputs.loanAmt * monthlyRate * Math.pow(1 + monthlyRate, inputs.tenure)) / (Math.pow(1 + monthlyRate, inputs.tenure) - 1) : 0;
  document.getElementById("monthlyEMIValue").innerText = fmt(emi);
  
  // Guard clause to prevent calculations on fresh load
  if (agreement === 0) {
    const cashFlowFields = ['currentPrice', 'rentCollected', 'totalIncomeValue', 'purchasePriceOutflow', 'preEmiInterestPaid', 'amortizedInterestPaid', 'interestPaid', 'maintenancePaid', 'totalExpensesValue', 'netResult'];
    cashFlowFields.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerText = fmt(0);
    });
    const roiFields = ['absoluteROI', 'annualizedROI'];
    roiFields.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.innerText = '0.00%';
            el.className = '';
        }
    });
    document.getElementById('projectionResult').innerHTML = '';
    return; // Exit before performing cash flow calculations
  }

  // 3. TIME-BASED CALCULATIONS
  let yearsHeld = 0;
  if (!isNaN(inputs.bookingDate.getTime()) && today > inputs.bookingDate) {
      yearsHeld = (today - inputs.bookingDate) / (1000 * 60 * 60 * 24 * 365.25);
  }
  
  const interestEndDate = (inputs.loanClosureDate && inputs.loanClosureDate < today) ? inputs.loanClosureDate : today;
  const preEmiEndDate = (inputs.loanClosureDate && inputs.loanClosureDate < inputs.possessionDate) ? inputs.loanClosureDate : inputs.possessionDate;
  const preEmiMonths = getMonthsDifference(inputs.bookingDate, preEmiEndDate);
  const preEmiInterest = inputs.loanAmt * monthlyRate * (preEmiMonths > 0 ? preEmiMonths - 1 : 0);
  const emiStartDate = inputs.possessionDate;
  const monthsForEmi = getMonthsDifference(emiStartDate, interestEndDate);
  const monthsForMaintenance = getMonthsDifference(inputs.possessionDate, today);

  // 4. AMORTIZATION (INTEREST & PRINCIPAL PAID)
  let balance = inputs.loanAmt;
  let amortizedInterest = 0;
  let monthsPaid = Math.min(monthsForEmi, inputs.tenure);

  for (let m = 0; m < monthsPaid; m++) {
    let interest = balance * monthlyRate;
    balance -= (emi - interest);
    amortizedInterest += interest;
  }
  
  const totalInterest = preEmiInterest + amortizedInterest;

  // 5. INCOME & EXPENSES TO DATE
  const rentCollected = calculateTotalRentCollected();
  const maintenancePaid = inputs.qMaint * Math.ceil(monthsForMaintenance / 3);
  
  // 6. CURRENT PROPERTY VALUE
  let currentPrice;
  if (inputs.salePrice > 0) {
      currentPrice = inputs.salePrice;
  } 
  else if (yearsHeld < (1 / 12)) { 
      currentPrice = allIncPrice;
  } 
  else {
      currentPrice = allIncPrice * Math.pow(1 + inputs.appRate, yearsHeld);
  }

  // 7. FINAL ROI METRICS
  const totalInflow = currentPrice + rentCollected;
  const totalOutflow = allIncPrice + totalInterest + maintenancePaid;
  const netProfit = totalInflow - totalOutflow;

  const absoluteROI = totalInitialCapital > 0 ? (netProfit / totalInitialCapital) * 100 : 0;
  const annualizedROI = totalInitialCapital > 0 && yearsHeld > 0 
      ? (Math.pow((totalInitialCapital + netProfit) / totalInitialCapital, 1 / yearsHeld) - 1) * 100 
      : 0;

  // 8. UPDATE THE UI
  const isMobile = window.innerWidth <= 600;
  const numberFormatter = isMobile ? fmtShort : fmt;

  document.getElementById("currentPrice").innerText = numberFormatter(currentPrice);
  document.getElementById("rentCollected").innerText = numberFormatter(rentCollected);
  document.getElementById("totalIncomeValue").innerText = numberFormatter(totalInflow);

  document.getElementById("purchasePriceOutflow").innerText = numberFormatter(allIncPrice);
  document.getElementById("preEmiInterestPaid").innerText = numberFormatter(preEmiInterest);
  document.getElementById("amortizedInterestPaid").innerText = numberFormatter(amortizedInterest);
  document.getElementById("interestPaid").innerText = numberFormatter(totalInterest);
  document.getElementById("maintenancePaid").innerText = numberFormatter(maintenancePaid);
  document.getElementById("totalExpensesValue").innerText = numberFormatter(totalOutflow);
  
  const netResultEl = document.getElementById("netResult");
  netResultEl.innerText = numberFormatter(netProfit);
  netResultEl.className = netProfit >= 0 ? 'positive' : 'negative';
  
  const absROIEl = document.getElementById("absoluteROI");
  absROIEl.innerText = `${absoluteROI.toFixed(2)}%`;
  absROIEl.className = absoluteROI >= 0 ? 'positive' : 'negative';

  const annROIEl = document.getElementById("annualizedROI");
  annROIEl.innerText = `${annualizedROI.toFixed(2)}%`;
  annROIEl.className = annualizedROI >= 0 ? 'positive' : 'negative';
  
  return { ...inputs, allIncPrice, yearsHeld, monthsSincePossession: monthsForMaintenance, totalInitialCapital, currentPrice, emi, currentBalance: balance, cumulativeRent: rentCollected, cumulativeInterest: totalInterest, cumulativeMaint: maintenancePaid };
}


// --- PROJECTION LOGIC ---
function generateProjection() {
    const currentData = calculateROI();
    const lastRentPeriod = document.querySelector('.rent-period:last-of-type .rent-amount');
    let lastRent = lastRentPeriod ? (parseFloat(lastRentPeriod.value) || 0) : 0;

    const horizon = parseInt(document.getElementById("horizon").value) || 5;
    const rentIncrease = parseFloat(document.getElementById("rentIncrease").value) / 100 || 0.05;

    let html = `<table><tr><th>Year</th><th>Est. Property Value</th><th>Loan Balance</th><th>Total Profit if Sold</th><th>Annualized ROI</th></tr>`;

    let propVal = currentData.currentPrice;
    let loanBal = currentData.currentBalance;
    let cumRent = currentData.cumulativeRent;
    let cumInt = currentData.cumulativeInterest;
    let cumMaint = currentData.cumulativeMaint;
    let monthsRemaining = Math.max(0, currentData.tenure - getMonthsDifference(currentData.possessionDate, new Date()));
    
    if(currentData.loanClosureDate && currentData.loanClosureDate < new Date()){
        monthsRemaining = 0;
    }


    for (let y = 1; y <= horizon; y++) {
        propVal *= (1 + currentData.appRate);
        lastRent *= (1 + rentIncrease);
        
        let interestThisYear = 0;
        let monthsToPay = Math.min(12, monthsRemaining);
        
        for (let m = 0; m < monthsToPay; m++) {
            let interest = loanBal * (currentData.ratePA / 100 / 12);
            interestThisYear += interest;
            loanBal -= (currentData.emi - interest);
        }
        
        cumInt += interestThisYear;
        cumRent += lastRent * 12;
        cumMaint += currentData.qMaint * 4;
        monthsRemaining -= monthsToPay;

        const totalProfitIfSold = (propVal + cumRent) - (currentData.allIncPrice + cumInt + cumMaint);
        const totalYears = currentData.yearsHeld + y;
        
        const annualizedROI = currentData.totalInitialCapital > 0 && totalYears > 0 
            ? (Math.pow((currentData.totalInitialCapital + totalProfitIfSold) / currentData.totalInitialCapital, 1 / totalYears) - 1) * 100 
            : 0;

        html += `<tr><td>${new Date().getFullYear() + y}</td><td>${fmt(propVal)}</td><td>${fmt(loanBal < 0 ? 0 : loanBal)}</td><td class="${totalProfitIfSold >= 0 ? 'positive' : 'negative'}">${fmt(totalProfitIfSold)}</td><td class="${annualizedROI >= 0 ? 'positive' : 'negative'}">${annualizedROI.toFixed(2)}%</td></tr>`;
    }

    html += "</table>";
    document.getElementById("projectionResult").innerHTML = html;
}

// --- SYNC LOAN INPUTS ---
function syncLoanInputs(source) {
    isUpdating = true;
    const agreementValue = parseFloat(document.getElementById('agreementValue').value) || 0;
    const ltvInput = document.getElementById('ltvPercent');
    const loanAmountInput = document.getElementById('loanAmount');

    if (source === 'ltv') {
        const ltv = parseFloat(ltvInput.value) || 0;
        const newLoanAmount = agreementValue * (ltv / 100);
        loanAmountInput.value = newLoanAmount.toFixed(0);
    } else if (source === 'amount') {
        const loanAmount = parseFloat(loanAmountInput.value) || 0;
        const newLtv = agreementValue > 0 ? (loanAmount / agreementValue) * 100 : 0;
        ltvInput.value = newLtv.toFixed(2);
    }
    isUpdating = false;
    calculateROI();
}

// --- EXPORT TO PDF ---
async function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const content = document.getElementById('capture');
    const exportBtn = document.getElementById('exportBtn');
    const originalBtnText = exportBtn.innerHTML;
    const originalTitle = content.querySelector('h1').innerHTML;
    
    exportBtn.innerHTML = 'Generating...';
    exportBtn.disabled = true;
    content.querySelector('h1').innerHTML = 'Prop Gain Report';

    // 1. Create replacements for inputs
    const replacements = [];
    const inputs = content.querySelectorAll('input[type="number"], input[type="month"]');
    inputs.forEach(input => {
        const textSpan = document.createElement('span');
        textSpan.className = 'print-text';
        textSpan.textContent = input.value || ' ';
        replacements.push({ original: input, replacement: textSpan });
        input.parentNode.insertBefore(textSpan, input);
        input.style.display = 'none';
    });

    // 2. Add a class to the container to hide buttons via CSS
    content.classList.add('exporting');

    try {
        const pdf = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4'
        });

        const pageHeight = pdf.internal.pageSize.getHeight();
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const margin = 10;
        let yPos = margin;

        const renderElement = async (element) => {
            const canvas = await html2canvas(element, { scale: 2, useCORS: true, logging: false });
            const imgData = canvas.toDataURL('image/png');
            const ratio = canvas.width / canvas.height;
            const imgHeight = (pdfWidth - margin * 2) / ratio;

            if (yPos + imgHeight > pageHeight - margin) {
                pdf.addPage();
                yPos = margin;
            }
            
            pdf.addImage(imgData, 'PNG', margin, yPos, pdfWidth - margin * 2, imgHeight);
            yPos += imgHeight + 5; // Add gap after element
        };

        // Render title
        await renderElement(content.querySelector('h1'));

        // Render each section
        const sections = Array.from(content.querySelectorAll('.section'));
        for (const section of sections) {
            // Don't render the export button section
            if (section.contains(exportBtn)) continue;
            await renderElement(section);
        }
        
        pdf.save('property-roi-summary.pdf');

    } catch (err) {
        console.error("Error generating PDF:", err);
        exportBtn.innerHTML = 'Failed! Try Again.';
    } finally {
        // 3. Restore original inputs, title, and remove temporary spans
        content.classList.remove('exporting');
        replacements.forEach(item => {
            item.original.style.display = '';
            item.replacement.remove();
        });
        
        content.querySelector('h1').innerHTML = originalTitle;
        exportBtn.innerHTML = originalBtnText;
        exportBtn.disabled = false;
    }
}


// --- INITIALIZE THE CALCULATOR ---
function init() {
  // Use 'input' for number fields for real-time updates as user types
  const numberInputs = [
    'agreementValue', 'stampDutyPercent', 'gstPercent', 'registrationCharges',
    'interestRate', 'tenure', 'quarterlyMaintenance', 'salePrice', 'appRate'
  ];
  numberInputs.forEach(id => {
    document.getElementById(id)?.addEventListener('input', calculateROI);
  });

  // Use 'change' for month fields, which fires after a date is selected
  const monthInputs = ['bookingDate', 'possessionDate', 'loanClosureDate'];
  monthInputs.forEach(id => {
    document.getElementById(id)?.addEventListener('change', calculateROI);
  });

  // Add specific listeners for synced loan inputs
  document.getElementById('ltvPercent').addEventListener('input', () => syncLoanInputs('ltv'));
  document.getElementById('loanAmount').addEventListener('input', () => syncLoanInputs('amount'));

  // Initial calculation on page load to sync LTV etc. if needed
  syncLoanInputs('ltv');
  calculateROI();

  // Recalculate on resize to switch number formatting
  window.addEventListener('resize', calculateROI);
}

window.onload = init;

</script>
</body>
</html>

